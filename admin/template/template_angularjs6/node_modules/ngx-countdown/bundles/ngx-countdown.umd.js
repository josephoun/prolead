(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/common'), require('@angular/core')) :
	typeof define === 'function' && define.amd ? define(['exports', '@angular/common', '@angular/core'], factory) :
	(factory((global.ngxCountDown = {}),global.ng.common,global.ng.core));
}(this, (function (exports,common,core) { 'use strict';

var Timer = (function () {
    function Timer() {
        this.fns = [];
        this.commands = [];
        this.ing = false;
    }
    Timer.prototype.start = function () {
        if (this.ing === true)
            return;
        this.ing = true;
        this.nextTime = +new Date();
        this.process();
    };
    Timer.prototype.process = function () {
        var _this = this;
        while (this.commands.length) {
            this.commands.shift()();
        }
        var diff = +new Date() - this.nextTime;
        var count = 1 + Math.floor(diff / 100);
        diff = 100 - diff % 100;
        this.nextTime += 100 * count;
        var frequency, step, i, len;
        for (i = 0, len = this.fns.length; i < len; i += 2) {
            frequency = this.fns[i + 1];
            // 100/s
            if (0 === frequency) {
                this.fns[i](count);
                // 1000/s
            }
            else {
                // 先把末位至0，再每次加2
                frequency += 2 * count - 1;
                step = Math.floor(frequency / 20);
                if (step > 0) {
                    this.fns[i](step);
                }
                // 把末位还原成1
                this.fns[i + 1] = frequency % 20 + 1;
            }
        }
        if (this.ing)
            setTimeout(function () { _this.process(); }, diff);
    };
    Timer.prototype.add = function (fn, frequency) {
        var _this = this;
        this.commands.push(function () {
            _this.fns.push(fn);
            _this.fns.push(frequency === 1000 ? 1 : 0);
            _this.ing = _this.fns.length > 0;
        });
    };
    Timer.prototype.remove = function (fn) {
        var _this = this;
        this.commands.push(function () {
            var i = _this.fns.indexOf(fn);
            if (i !== -1) {
                _this.fns.splice(i, 2);
            }
            _this.ing = _this.fns.length > 0;
        });
    };
    Timer.decorators = [
        { type: core.Injectable },
    ];
    /** @nocollapse */
    Timer.ctorParameters = function () { return []; };
    return Timer;
}());

var CountdownComponent = (function () {
    function CountdownComponent(el, renderer, timer) {
        this.el = el;
        this.renderer = renderer;
        this.timer = timer;
        this.frequency = 1000;
        this._notify = {};
        this.hands = [];
        this.left = 0;
        this.parsed = false;
        this.stoped = false;
        this.start = new core.EventEmitter();
        this.finished = new core.EventEmitter();
        this.notify = new core.EventEmitter();
        this.event = new core.EventEmitter();
        this.timer.start();
    }
    CountdownComponent.prototype.ngOnInit = function () {
        this.mergeConfig();
        this.init();
        if (!this.config.demand)
            this.begin();
    };
    CountdownComponent.prototype.ngOnDestroy = function () {
        this.destroy();
    };
    CountdownComponent.prototype.ngOnChanges = function (changes) {
        if (!changes.config.firstChange) {
            this.mergeConfig();
            this.destroy().init();
        }
    };
    CountdownComponent.prototype.begin = function () {
        this.parsed = false;
        this.callEvent('start');
    };
    CountdownComponent.prototype.restart = function () {
        if (!this.stoped)
            this.destroy();
        this.init();
        this.timer.start();
        this.callEvent('restart');
    };
    CountdownComponent.prototype.stop = function () {
        if (this.stoped)
            return;
        this.stoped = true;
        this.destroy();
        this.callEvent('stop');
    };
    CountdownComponent.prototype.pause = function () {
        if (this.stoped || this.parsed)
            return;
        this.parsed = true;
        this.callEvent('pause');
    };
    CountdownComponent.prototype.resume = function () {
        if (this.stoped || !this.parsed)
            return;
        this.parsed = false;
        this.callEvent('resume');
    };
    CountdownComponent.prototype.mergeConfig = function () {
        this.config = Object.assign({
            demand: false,
            leftTime: 0,
            template: '$!h!时$!m!分$!s!秒',
            size: 'lite',
            effect: 'normal',
            varRegular: /\$\!([\-\w]+)\!/g,
            clock: ['d', 100, 2, 'h', 24, 2, 'm', 60, 2, 's', 60, 2, 'u', 10, 1]
        }, this.config);
    };
    CountdownComponent.prototype.callEvent = function (action) {
        this.event.emit({ action: action, left: this.left });
    };
    CountdownComponent.prototype.init = function () {
        var me = this;
        var el = me.el.nativeElement;
        me.parsed = me.config.demand;
        me.stoped = false;
        this.cls = "count-down " + me.config.size + " " + (me.config.className || '');
        // 分析markup
        var tmpl = el.innerHTML || me.config.template;
        me.config.varRegular.lastIndex = 0;
        el.innerHTML = tmpl.replace(me.config.varRegular, function (str, type) {
            // 时钟频率校正.
            if (type === 'u' || type === 's-ext')
                me.frequency = 100;
            // 生成hand的markup
            var content = '';
            if (type === 's-ext') {
                me.hands.push({ type: 's' });
                me.hands.push({ type: 'u' });
                content = me.html('', 's', 'handlet') +
                    me.html('.', '', 'digital') +
                    me.html('', 'u', 'handlet');
            }
            else {
                me.hands.push({ type: type });
            }
            return me.html(content, type, 'hand');
        });
        var clock = me.config.clock;
        me.hands.forEach(function (hand) {
            var type = hand.type;
            var base = 100, i;
            hand.node = el.querySelector(".hand-" + type);
            // radix, bits 初始化
            for (i = clock.length - 3; i > -1; i -= 3) {
                if (type === clock[i]) {
                    break;
                }
                base *= clock[i + 1];
            }
            hand.base = base;
            hand.radix = clock[i + 1];
            hand.bits = clock[i + 2];
        });
        me.getLeft();
        me.reflow(0, true);
        // bind reflow to me
        var _reflow = me.reflow;
        me.reflow = function (count) {
            if (count === void 0) { count = 0; }
            return _reflow.apply(me, [count]);
        };
        // 构建 notify
        if (me.config.notify) {
            me.config.notify.forEach(function (time) {
                if (time < 1)
                    throw new Error('由于当结束会调用 finished，所以 notify 通知必须全是正整数');
                time = time * 1000;
                time = time - time % me.frequency;
                me._notify[time] = true;
            });
        }
        me.start.emit();
        me.timer.add(me.reflow, me.frequency);
        // show
        el.style.display = 'inline';
        return me;
    };
    CountdownComponent.prototype.destroy = function () {
        this.timer.remove(this.reflow);
        return this;
    };
    /**
     * 更新时钟
     */
    /**
         * 更新时钟
         */
    CountdownComponent.prototype.reflow = /**
         * 更新时钟
         */
    function (count, force) {
        if (count === void 0) { count = 0; }
        if (force === void 0) { force = false; }
        if (!force && (this.parsed || this.stoped))
            return;
        var me = this;
        me.left = me.left - me.frequency * count;
        me.hands.forEach(function (hand) {
            hand.lastValue = hand.value;
            hand.value = Math.floor(me.left / hand.base) % hand.radix;
        });
        me.repaint();
        if (me._notify[me.left]) {
            me.notify.emit(me.left);
            this.callEvent('notify');
        }
        if (me.left < 1) {
            me.finished.emit(0);
            this.stoped = true;
            this.callEvent('finished');
            this.destroy();
        }
    };
    /**
     * 重绘时钟
     */
    /**
         * 重绘时钟
         */
    CountdownComponent.prototype.repaint = /**
         * 重绘时钟
         */
    function () {
        var me = this;
        if (me.config.repaint) {
            me.config.repaint.apply(me);
            return;
        }
        var content;
        me.hands.forEach(function (hand) {
            if (hand.lastValue !== hand.value) {
                content = '';
                me.toDigitals(hand.value, hand.bits).forEach(function (digital) {
                    content += me.html(digital.toString(), '', 'digital');
                });
                hand.node.innerHTML = content;
            }
        });
    };
    /**
     * 获取倒计时剩余帧数
     */
    /**
         * 获取倒计时剩余帧数
         */
    CountdownComponent.prototype.getLeft = /**
         * 获取倒计时剩余帧数
         */
    function () {
        var left = this.config.leftTime * 1000;
        var end = this.config.stopTime;
        if (!left && end)
            left = end - new Date().getTime();
        this.left = left - left % this.frequency;
    };
    /**
     * 生成需要的html代码，辅助工具
     */
    /**
         * 生成需要的html代码，辅助工具
         */
    CountdownComponent.prototype.html = /**
         * 生成需要的html代码，辅助工具
         */
    function (con, className, type) {
        if (con instanceof Array) {
            con = con.join('');
        }
        switch (type) {
            case 'hand':
            case 'handlet':
                className = type + ' hand-' + className;
                break;
            case 'digital':
                if (con === '.') {
                    className = type + ' ' + type + '-point ' + className;
                }
                else {
                    className = type + ' ' + type + '-' + con + ' ' + className;
                }
                break;
        }
        return '<span class="' + className + '">' + con + '</span>';
    };
    /**
     * 把值转换为独立的数字形式
     */
    /**
         * 把值转换为独立的数字形式
         */
    CountdownComponent.prototype.toDigitals = /**
         * 把值转换为独立的数字形式
         */
    function (value, bits) {
        value = value < 0 ? 0 : value;
        var digitals = [];
        // 把时、分、秒等换算成数字.
        while (bits--) {
            digitals[bits] = value % 10;
            value = Math.floor(value / 10);
        }
        return digitals;
    };
    CountdownComponent.decorators = [
        { type: core.Component, args: [{
                    selector: 'countdown',
                    template: "<ng-content></ng-content>",
                    styles: [".count-down{display:none}.count-down.medium .digital{color:#404040;font-size:24px}.count-down.large .hand{display:inline-block;padding:0 2px;width:32px;height:35px;line-height:35px;box-sizing:initial;background:url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAF8AAAAjCAYAAADyrNZPAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAACxMAAAsTAQCanBgAAAHRSURBVGje7doxihtBEEbhV0NHwjCgRAYfwIMDH8BsugfYK0g6gMFX2NTgA+gsmxi8NzBStKnB0cJKkfovB17JJ+ipAndHAiXva0rFCMY2mw3AO+ArcPP6ec7zC3gEvux2uyeA7XYb2TOb1dbr9Xvgh5ktzSykyN1x92fgE1Cje+ayFne/N7Pl5YvAM7r7PVCT9DS3Fne/NbMUUHe/5e/lp+hpbS2Sxiw/b0lvALL0tLaW1x0U3QL8WzNZelpbiySGYYhuAUASQJqe1tYiKc2kXS4/S09ra187gdYi6Tpx0efSkaWntbWvnUBrv/xAa187gdZ++YHWvnYCrX3yA6198gOtRRKLxSK6BYDj8QiQpqe1tdRaORwO0S0AjOMIkKantbVIYrVaRbcAcDqdANL0tLb2nR9o7U87gdZ++YHWfvmB1n75gdYiifP5HN1yDQLS9LS2FknUWqNbrkFAmp7W1j75gdbi7mkm7fJ8n6WntbVPfqA11T/c/+7tBXd/ljRGxwCY2QtQs/S0thZJD+5+Fz1tZoaZPQA1Q88cVpum6QPwXdIyCmxmDMNweT+f6J65rMXdfwIfzeybmd0Ab2fu+Q08uvvn/X7/BDBNU2TPbNY/RYn/l73uadIAAAAASUVORK5CYII=\") no-repeat}.count-down.large .digital{color:#fff;font-size:28px}.count-down.large .hand-s-ext{width:59px;background-position:-36px 0} "],
                    encapsulation: core.ViewEncapsulation.None
                },] },
    ];
    /** @nocollapse */
    CountdownComponent.ctorParameters = function () { return [
        { type: core.ElementRef, },
        { type: core.Renderer, },
        { type: Timer, },
    ]; };
    CountdownComponent.propDecorators = {
        "config": [{ type: core.Input },],
        "start": [{ type: core.Output },],
        "finished": [{ type: core.Output },],
        "notify": [{ type: core.Output },],
        "event": [{ type: core.Output },],
        "cls": [{ type: core.HostBinding, args: ['class',] },],
    };
    return CountdownComponent;
}());

var CountdownModule = (function () {
    function CountdownModule() {
    }
    CountdownModule.decorators = [
        { type: core.NgModule, args: [{
                    imports: [common.CommonModule],
                    providers: [Timer],
                    declarations: [CountdownComponent],
                    exports: [CountdownComponent]
                },] },
    ];
    /** @nocollapse */
    CountdownModule.ctorParameters = function () { return []; };
    return CountdownModule;
}());

exports.CountdownModule = CountdownModule;
exports.CountdownComponent = CountdownComponent;

Object.defineProperty(exports, '__esModule', { value: true });

})));
